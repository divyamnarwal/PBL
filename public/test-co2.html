<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CO2 Monitor Test - No Auth</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mqtt@5/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .status-indicator.connected {
      background-color: #10b981;
      animation: pulse-green 2s infinite;
    }
    
    .status-indicator.connecting {
      background-color: #fbbf24;
      animation: pulse-yellow 1s infinite;
    }
    
    .status-indicator.disconnected {
      background-color: #ef4444;
    }
    
    @keyframes pulse-green {
      0%, 100% {
        opacity: 1;
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      }
      50% {
        opacity: 0.8;
        box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
      }
    }
    
    @keyframes pulse-yellow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold text-white text-center mb-8">üå± Real-Time CO2 Monitor (Test Mode)</h1>
    
    <!-- Real-Time CO2 Monitoring Section -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-2xl">
      <!-- Section Header -->
      <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
            üå± Live CO‚ÇÇ Monitoring
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
            Real-time sensor data via MQTT (or simulated in console)
          </p>
        </div>
        <!-- Connection Status -->
        <div class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700">
          <span id="status-indicator" class="status-indicator disconnected"></span>
          <span id="status-text" class="text-sm font-medium text-gray-700 dark:text-gray-300">Connecting...</span>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Current CO2 Card -->
        <div class="col-span-1 md:col-span-2 bg-gradient-to-br from-green-50 to-blue-50 dark:from-gray-700 dark:to-gray-600 rounded-xl p-6 border-2 border-green-200 dark:border-green-700">
          <div class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Current CO‚ÇÇ Level</div>
          <div class="flex items-baseline gap-3">
            <div id="co2-value" class="text-5xl font-bold text-green-600 dark:text-green-400">
              --
            </div>
            <div class="text-2xl font-medium text-gray-500 dark:text-gray-400">ppm</div>
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div id="co2-quality" class="text-lg font-semibold">
              üü° Waiting for data...
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400" id="last-update">
              Never
            </div>
          </div>
        </div>

        <!-- Min Value Card -->
        <div class="bg-white dark:bg-gray-700 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-600">
          <div class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Today's Minimum</div>
          <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">
            <span id="min-value">--</span> <span class="text-sm font-normal">ppm</span>
          </div>
          <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">Lowest recorded</div>
        </div>

        <!-- Max Value Card -->
        <div class="bg-white dark:bg-gray-700 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-600">
          <div class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Today's Maximum</div>
          <div class="text-2xl font-bold text-red-600 dark:text-red-400">
            <span id="max-value">--</span> <span class="text-sm font-normal">ppm</span>
          </div>
          <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">Highest recorded</div>
        </div>
      </div>

      <!-- Chart and Info Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Trend Chart -->
        <div class="lg:col-span-2 bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-600">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">CO‚ÇÇ Trend</h3>
            <div class="text-xs text-gray-500 dark:text-gray-400">Last 50 readings</div>
          </div>
          <div class="relative" style="height: 300px;">
            <canvas id="co2-chart"></canvas>
          </div>
        </div>

        <!-- Statistics and Sensor Info -->
        <div class="space-y-4">
          <!-- Average Card -->
          <div class="bg-white dark:bg-gray-700 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-600">
            <div class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Session Average</div>
            <div class="text-3xl font-bold text-purple-600 dark:text-purple-400">
              <span id="avg-value">--</span> <span class="text-sm font-normal">ppm</span>
            </div>
            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">Mean CO‚ÇÇ level</div>
          </div>

          <!-- Sensor Info Card -->
          <div class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600 rounded-xl p-4 border border-gray-200 dark:border-gray-600">
            <div class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-3">Sensor Information</div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-300">Type:</span>
                <span id="sensor-type" class="font-medium text-gray-800 dark:text-gray-100">MH-Z19</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-300">Status:</span>
                <span id="sensor-status" class="font-medium text-gray-800 dark:text-gray-100">Initializing...</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-300">Protocol:</span>
                <span class="font-medium text-gray-800 dark:text-gray-100">MQTT/Simulated</span>
              </div>
            </div>
          </div>

          <!-- CO2 Level Guide -->
          <div class="bg-white dark:bg-gray-700 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-600">
            <div class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-3">CO‚ÇÇ Level Guide</div>
            <div class="space-y-2 text-xs">
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="text-gray-600 dark:text-gray-300">400-600: Excellent</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                <span class="text-gray-600 dark:text-gray-300">600-1000: Good</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                <span class="text-gray-600 dark:text-gray-300">1000-1500: Moderate</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="text-gray-600 dark:text-gray-300">1500+: Poor</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Instructions -->
      <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
        <h3 class="font-semibold text-blue-900 dark:text-blue-100 mb-2">üìù How to Test:</h3>
        <p class="text-sm text-blue-800 dark:text-blue-200 mb-3">
          Press <kbd class="px-2 py-1 bg-white dark:bg-gray-800 rounded border">F12</kbd> to open Developer Console, then paste this code:
        </p>
        <pre class="text-xs bg-gray-900 text-green-400 p-3 rounded overflow-x-auto"><code>// Simulate real-time CO2 data
setInterval(() => {
  const co2 = 550 + Math.random() * 200;
  const data = {
    co2: Math.round(co2),
    status: 'OK',
    timestamp: new Date().toISOString(),
    sensor: 'MH-Z19 (Simulated)'
  };
  window.realTimeMonitor?.handleData(data);
  console.log('üìä Simulated:', data.co2, 'ppm');
}, 2000);</code></pre>
        <p class="text-xs text-blue-700 dark:text-blue-300 mt-2">
          ‚ú® Watch the dashboard come alive with real-time updates!
        </p>
      </div>
    </div>
  </div>

<script type="module">
  // Import MQTT Service and Real-Time Monitor
  import { MQTTService } from '../js/mqtt-service.js';
  import { RealTimeMonitor } from '../js/real-time-monitor.js';

  // Initialize Real-Time CO2 Monitoring
  let mqttService = null;
  let realTimeMonitor = null;

  async function initRealTimeMonitoring() {
    console.log('üöÄ Initializing Real-Time CO2 Monitor (Test Mode)...');
    console.log('');
    console.log('üìù INSTRUCTIONS:');
    console.log('  1. This page tries to connect to MQTT broker (will fail if not installed)');
    console.log('  2. To test without MQTT, paste this code in console:');
    console.log('');
    console.log('setInterval(() => {');
    console.log('  const co2 = 550 + Math.random() * 200;');
    console.log('  const data = {');
    console.log('    co2: Math.round(co2),');
    console.log('    status: "OK",');
    console.log('    timestamp: new Date().toISOString(),');
    console.log('    sensor: "MH-Z19 (Simulated)"');
    console.log('  };');
    console.log('  window.realTimeMonitor?.handleData(data);');
    console.log('  console.log("üìä Simulated:", data.co2, "ppm");');
    console.log('}, 2000);');
    console.log('');
    
    // Create MQTT service
    mqttService = new MQTTService({
      brokerUrl: 'ws://localhost:9001',
      topic: 'sensor/co2'
    });

    // Create real-time monitor
    realTimeMonitor = new RealTimeMonitor(mqttService);

    // Make instances available globally BEFORE init
    window.mqttService = mqttService;
    window.realTimeMonitor = realTimeMonitor;

    try {
      // Initialize the monitor (this will try to connect to MQTT)
      await realTimeMonitor.init();
      console.log('‚úÖ Monitor initialized and connected to MQTT!');
    } catch (error) {
      console.warn('‚ö†Ô∏è MQTT connection failed (expected if broker not running)');
      console.log('üí° Use the simulation code above to test the UI');
      console.log('');
      console.log('‚úÖ Monitor is ready - you can now paste the simulation code!');
      
      // Set status to show it's ready for simulation
      const statusText = document.getElementById('status-text');
      const statusIndicator = document.getElementById('status-indicator');
      if (statusText) statusText.textContent = 'Ready for simulation';
      if (statusIndicator) {
        statusIndicator.classList.remove('connecting', 'connected');
        statusIndicator.classList.add('disconnected');
      }

      // Initialize just the DOM elements and chart (without MQTT connection)
      realTimeMonitor.initElements();
      realTimeMonitor.initChart();
    }
  }

  // Start when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRealTimeMonitoring);
  } else {
    initRealTimeMonitoring();
  }
</script>
</body>
</html>
